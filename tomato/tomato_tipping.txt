@name Tomato Tipping
@inputs Jar:entity
@outputs 
@persist Amount ReqAmount TopAmount SecAmount ThAmount TotalAmount DonateCount
@persist [Places Amounts]:array [Buyer]:entity
@persist [TopPlayer SecPlayer ThPlayer SaveUser]:string
@trigger 

###################################################
#Coded by Bob Tomato, any changes or reqs /pm me :)
###################################################

if (first() || dupefinished() || ~EGP) {
    #include "library/tomato_lib"
    
    #Global Variables
    #-------------------------------------------#
    
    Amount = 10000
    Dark = vec(43, 43, 40)
    Primary = vec(227, 176, 75)
    Secondary = vec(241, 214, 171)
    Light = vec(248, 248, 248)
    
    Owner = owner()
    Donators = array()
    Buyer = noentity()
    Prefix = "BLACK PYRAMID"
    
    #Program Specific Functions
    #-------------------------------------------#
    
    function createSideTriangle(Text:string, Size, Color:vector, Coords:vector2, Dir) {
        local ID = Elements:get(Text)
        local CoordBottom = vec2(Coords:x(), Coords:y() - Size)
        local CoordSide = vec2(Coords:x() + Size/2*Dir, Coords:y() - Size/2)
        EGP:egpTriangle(ID,Coords,CoordBottom,CoordSide)
        EGP:egpColor(ID,Color)
    }
    
    function createBall(Num) {
        local ID = Elements:get("1WreathBack")
        local Pos = EGP:egpPos(ID)
        local Size = EGP:egpSize(ID)
        local XCoords = randint(Pos:x()-Size:x(),Pos:x()+Size:x())
        local YCoords = randint(Pos:y(),Pos:y()+Size:y())
        local BallSize = randint(2,6)
        
        createCircle("Circle"+Num, size(BallSize), color(Secondary), coords(vec2(XCoords, YCoords)))
    }
    
    function string formatNumber(Num) {
        local String = toString(Num)
        local Length = String:length()
        local Seperator = floor(Length/3)
        local Format = ""
        for (I=1, Length) {
            local Index = Length-I+1
            if (I != 1 & mod(I, 3) == 1) {
                Format += ","
            }
            Format += String[Index]
        }
        return Format:reverse()
    }
    
    function number key(User:entity, Key:string, Entity:entity){
        if(User:keyPressed(Key) & User:aimEntity() == Entity ){
            return 1
        }
        return 0
    }
    
    #Draw initial screen
    #-------------------------------------------#
    
    EGP:egpClear()
    
    #Generic
    local Offset = 70
    createBox("Background",size(vec2(ScreenXY,ScreenXY)), color(Dark), coords(vec2(0,0)))
    createText("Title",size(36),align(1),coords(vec2(ScreenXY/2,0)))
    createText("A Tomato Production",size(16),coords(vec2(ScreenXY/2-60,30))) 
    createText("Description",size(24),align(1),coords(vec2(ScreenXY/2,60))) 

    #Leaderboard Table
    createBox("TableBackground",size(vec2(ScreenXY-20,50*6)), color(White), coords(vec2(10,140)))
    
    createCircle("1Wreath", size(60), color(Secondary), coords(vec2(ScreenXY/2-Offset, 196)))
    createCircle("1WreathBack", size(60), color(White), coords(vec2(ScreenXY/2-Offset, 192)))
    for (I = 1, 5) {
        createBall(I)
    }
    
    createBox("Header",size(vec2(ScreenXY-20,40)), color(Primary), coords(vec2(10,100)))
    createText("Top Tippers of The Day",size(16),coords(vec2(20,110)))
    createTriangle("Pyramid1", size(10),color(Secondary), coords(vec2(ScreenXY-110, 120)))
    createTriangle("Pyramid2", size(15),color(Secondary), coords(vec2(ScreenXY-80, 115)))
    createTriangle("Pyramid3", size(20),color(Secondary), coords(vec2(ScreenXY-40, 110)))
    
    #1st Place
    createText("1st Name",size(30),color(Dark),align(1),coords(vec2(ScreenXY/2-Offset,150)))
    createText("1st Amount",size(20),color(Dark),align(1),coords(vec2(ScreenXY/2-Offset,175)))
    createText("1st.",size(30),color(Primary),align(1),coords(vec2(ScreenXY/2-Offset,200)))
    createCircle("1Circle", size(10), color(Secondary), coords(vec2(ScreenXY/2-Offset, 250)))
    createSideTriangle("1Right1", size(20),color(Secondary), coords(vec2(ScreenXY/2+10-Offset, 260)), 1)
    createSideTriangle("1Right2", size(15),color(Secondary), coords(vec2(ScreenXY/2+17.5-Offset, 257.5)), 1)
    createSideTriangle("1Left1", size(20),color(Secondary), coords(vec2(ScreenXY/2-10-Offset, 260)), -1)
    createSideTriangle("1Left2", size(15),color(Secondary), coords(vec2(ScreenXY/2-17.5-Offset, 257.5)), -1)
    #createBox("Bar",size(vec2(100,2)), color(Secondary), coords(vec2(ScreenXY/2-50-Offset,249)))
    
    #2nd Place
    createText("2nd Name",size(30),color(Dark),align(1),coords(vec2(ScreenXY/2-100-Offset,300)))
    createText("2nd Amount",size(20),color(Dark),align(1),coords(vec2(ScreenXY/2-100-Offset,325)))
    createText("2nd.",size(30),color(Primary),align(1),coords(vec2(ScreenXY/2-100-Offset,350)))
    createCircle("2Circle", size(10), color(Secondary), coords(vec2(ScreenXY/2-100-Offset, 400)))
    createSideTriangle("2Right1", size(20),color(Secondary), coords(vec2(ScreenXY/2-90-Offset, 410)), 1)
    createSideTriangle("2Left1", size(20),color(Secondary), coords(vec2(ScreenXY/2-110-Offset, 410)), -1)
    createSideTriangle("2Left2", size(15),color(Secondary), coords(vec2(ScreenXY/2-117.5-Offset, 407.5)), -1)
    createSideTriangle("2Right2", size(15),color(Secondary), coords(vec2(ScreenXY/2-82.5-Offset, 407.5)), 1)
    
    #3rd Place
    createText("3rd Name",size(30),color(Dark),align(1),coords(vec2(ScreenXY/2+100-Offset,300)))
    createText("3rd Amount",size(20),color(Dark),align(1),coords(vec2(ScreenXY/2+100-Offset,325)))
    createText("3rd.",size(30),color(Primary),align(1),coords(vec2(ScreenXY/2+100-Offset,350)))
    createCircle("3Circle", size(10), color(Secondary), coords(vec2(ScreenXY/2+100-Offset, 400)))
    createSideTriangle("3Right1", size(20),color(Secondary), coords(vec2(ScreenXY/2+110-Offset, 410)), 1)
    createSideTriangle("3Left1", size(20),color(Secondary), coords(vec2(ScreenXY/2+90-Offset, 410)), -1)
    
    #Recent Tippers
    createBox("TipperBackground",size(vec2(130,50*6)), color(Light), coords(vec2(ScreenXY-140,140)))
    createBox("Column1",size(vec2(1,50*6)), color(Secondary), coords(vec2(ScreenXY-140,140)))
    createText("Recent Tippers",size(16),color(Dark),align(1),coords(vec2(440,150)))
    
    
    #Footer info
    EGP:egpTriangle(Elements:get("ArrowHead"), vec2(ScreenXY-30, ScreenXY-30), vec2(ScreenXY-30, ScreenXY-50), vec2(ScreenXY-10, ScreenXY-40))
    createText("Tip Jar",size(16),coords(vec2(ScreenXY-80,463)))
    createText("TipAmount",size(16),coords(vec2(10,463)))
    createSlider("Slider", size(vec2(200, 20)), coords(vec2(ScreenXY/2-100, ScreenXY-50)))
    createText("Set Tip Amount",size(16),align(1),coords(vec2(ScreenXY/2,485)))
    
    #Customize Elements
    EGP:egpSetText(Elements:get("Title"),"TIPPING SYSTEM")
    EGP:egpSetText(Elements:get("TipAmount"),"Tip: $"+Amount)
    EGP:egpAngle(Elements:get("ArrowHead"), 180)
    EGP:egpSetText(Elements:get("Description"),"Press [E] on the Jar to Tip.")
}

interval(100)

for (I = 1, 5) {
    local ID = Elements:get("Circle"+I)
    local Alpha = EGP:egpAlpha(ID)
    local Pos = EGP:egpPos(ID)
    local Rand = randint(10, 20)
    
    EGP:egpAlpha(ID,Alpha - Rand)
    if (Alpha <= 0) {
        EGP:egpAlpha(ID,255)
        createBall(I)
    }
}

SliderValue = useSlider("Slider", 10000, 1000000, 1000)
if (SliderValue) {
    Amount = SliderValue
    EGP:egpSetText(Elements:get("TipAmount"),"Tip: $"+Amount)
}

event playerUse(Player:entity, Entity:entity) {
    if (Entity == Jar) {
        findByClass("player")
        Buyer = Player
        ReqAmount = Amount
        SaveUser = Buyer:name()
        moneyRequest(Buyer, ReqAmount, "Tip " + ReqAmount + "?")
    }
}

#Person pays
if(moneyClk()){
    AcountFound = 0
    for(I = 1,Places:count()){
        if(Places[I,string] == SaveUser){
            PlacesNum = I AcountFound = 1
        }
    }
    if(AcountFound == 1){#they have donated before so add the amount to their account
        Amounts[PlacesNum,number] = Amounts[PlacesNum,number] + ReqAmount 
    }
    else{#they are a first time donator so let's create them an account
        Places:pushString(SaveUser)
        Amounts:pushNumber(ReqAmount)  
    }

    #Find what place everyone is on the leader board
    for (I = 1,Amounts:count()){          
    if(Amounts[I,number] == TopAmount){Amounts[I,number]=Amounts[I,number]+1}
    if(Amounts[I,number] > TopAmount){TopAmount = Amounts[I,number] TopPlayer = Places[I,string]}

    if(Amounts[I,number] == SecAmount){Amounts[I,number]=Amounts[I,number]+1}
    if(Amounts[I,number] > SecAmount && Amounts[I,number] < TopAmount){SecAmount = Amounts[I,number] SecPlayer = Places[I,string]}

    if(Amounts[I,number] == ThAmount){Amounts[I,number]=Amounts[I,number]+1}
    if(Amounts[I,number] > ThAmount && Amounts[I,number] < SecAmount){ThAmount = Amounts[I,number] ThPlayer = Places[I,string]}
    }
 
    #Tally Total
    TotalAmount += ReqAmount
    
    EGP:egpSetText(Elements:get("1st Name"),TopPlayer)
    EGP:egpSetText(Elements:get("2nd Name"),SecPlayer)
    EGP:egpSetText(Elements:get("3rd Name"),ThPlayer)
    EGP:egpSetText(Elements:get("1st Amount"),"$"+formatNumber(TopAmount))
    EGP:egpSetText(Elements:get("2nd Amount"),"$"+formatNumber(SecAmount))
    EGP:egpSetText(Elements:get("3rd Amount"),"$"+formatNumber(ThAmount))
    
    #Add to recent tippers
    DonateCount++
    if (mod(14,DonateCount) == 1){
        for (I=1, DonateCount) {
            EGP:egpRemove(Elements:get("DonateCount"+I))
        }
        DonateCount=1
    }
    createText("DonateCount"+DonateCount,size(16),color(Dark),align(1),coords(vec2(440,170+DonateCount*20)))
    EGP:egpSetText(Elements:get("DonateCount"+DonateCount), SaveUser+": $" + ReqAmount/1000+"k")
    
    #Notifications
    Buyer:msg("Thank you so much for tipping!")
    Owner:msg(SaveUser+" just tipped: $"+ReqAmount)
    Owner:msg("Total amount tipped: $"+TotalAmount)
}

runOnChat(1)#this is a function to test wbat it would look like if someone else pushed the button
if(chatClk(owner()))  
{  
    if(owner():lastSaid():index(1) == "!")  
    {  
        Arguments = owner():lastSaid():sub(2):explode(" ")
        Command = Arguments:shiftString() 
        if(Command == "add")  
        {                    
            SaveUser = Arguments[1,string]
            moneyRequest(owner(),Amount)
        }
    }  
}

